<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html;charset=windows-1251">
</head>
<link rel="stylesheet" href="../STYLE.css">
<body TEXT="#000000" BGCOLOR="#E7E3E7" LINK="#004080" VLINK="#004080" olink="#008080" Background="">
<table BORDER=0   COLS=3 WIDTH="16%" >
  <tr> 
    <td><a href="Index2.html"><img SRC="Back.gif"  BORDER=0 ></a></td>
    <td WIDTH="10%"><a href="../menu.html"><img SRC="Menu.gif" BORDER=0 ></a></td>
    <td ALIGN=RIGHT><a href="Index4.html"><img SRC="For.gif" BORDER=0 ></a></td>
  </tr>
</table>

 
<br>
<table width="100%" border="0">
  <tr>
    <td class="Text_n">
 
<p class="Tit_CN">

Сканирование</P>

<p class="Text_n">
Операционная система Windows 2000 прослушивает список портов, многие из которых не были задействованы в Windows NT 4 и появились лишь в этой версии операционной системы. В табл. 6.1 приводится список некоторых портов, прослушиваемых по умолчанию контроллером домена Windows 2000. Каждый из них является потенциальной точкой входа в систему.
<br>
<p class="Prim">
Список номеров портов TCP и UDP, используемых службами и программами компании    Microsoft,    можно    найти    в    перечне    ресурсов    по    адресу http://www.microsoft.com/windows2000/<br>library/resouces/reslcit/ samplechapters/default.asp.&nbsp;
</p>
<P class="text_n"><span class="label">
Таблица 6.1. Список портов, прослушиваемых по
умолчанию контроллером домена Windows 2000
</span></p>
<TABLE  BORDER="1" CELLSPACING="2" CELLPADDING="2" WIDTH="100%" bordercolordark="#000000"
bordercolorlight="#000000" class="border" >
<TR >
<TD   >


<span class="Text_b">
Порт</span>
<br>

</TD>
<TD   >


<span class="Text_b">
Служба</span>
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 25
<br>

</TD>
<TD    >


SMTP
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 21
<br>

</TD>
<TD    >


FTP
<br>

</TD>
</TR>
<TR >
<TD    >


TCP/UDP 53
<br>

</TD>
<TD    >


DNS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 80
<br>

</TD>
<TD    >


WWW
<br>

</TD>
</TR>
<TR >
<TD    >


TCP/UDP 88
<br>

</TD>
<TD    >


Kerberos
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 135
<br>

</TD>
<TD    >


RPC/DCE Endpoint mapper
<br>

</TD>
</TR>
<TR >
<TD    >


UDP 137
<br>

</TD>
<TD    >


Служба имен NetBIOS
<br>

</TD>
</TR>
<TR >
<TD    >


UDP 138
<br>

</TD>
<TD    >


Служба дейтаграмм NetBIOS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 139
<br>

</TD>
<TD    >


Служба сеансов NetBIOS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP/UDP 389
<br>

</TD>
<TD    >


LDAP
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 443
<br>

</TD>
<TD    >


HTTP поверх SSl/TLS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP/UDP 445
<br>

</TD>
<TD    >


Microsoft SMB/CIFS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP/UDP 464
<br>

</TD>
<TD    >


Kerberos kpasswd
<br>

</TD>
</TR>
<TR >
<TD    >


UDP 500
<br>

</TD>
<TD    >


IKE (Internet Key Exchange) (согласно протоколу IPSec)
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 593
<br>

</TD>
<TD    >


HTTP RPC Endpoint mapper
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 636
<br>

</TD>
<TD    >


LDAP поверх SSLДLS
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 3268
<br>

</TD>
<TD    >


Глобальный каталог службы активных каталогов
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 3269
<br>

</TD>
<TD    >


Глобальный каталог службы активных каталогов поверх SSL
<br>

</TD>
</TR>
<TR >
<TD    >


TCP 3389
<br>

</TD>
<TD    >


Терминальный сервер Windows
<br>

</TD>
</TR>
</TABLE>
<P align="center">
<span class="Text_b">
Контрмеры: отключение служб и блокировка портов</span></P>
<br>
<p class="Text_n">
Наилучший способ предотвращения всевозможных атак — это блокировка доступа к этим службам как на уровне сети, так и на уровне отдельных компьютеров.
<br>

Внешние устройства контроля доступа к сети (переключатели, маршрутизаторы, брандмауэры и т.д.) нужно сконфигурировать таким образом, чтобы пресечь любые попытки доступа извне ко всем указанным портам, (Обычно это делается следующим образом. Отключаются все протоколы для всех доменов, а затем подключаются только некоторые службы для избранных доменов.) При этом, конечно, необходимо помнить об очевидных исключениях: порт 80 или 443 нужно оставить для работы Web-серверов. Ни один из этих портов не должен быть доступен за пределами сети, и лишь некоторые могут предоставляться для использования проверенными пользователями внутренних подсетей. Особенно это касается контроллера домена. На это есть две причины.
<br>
<ul>
  <li>&nbsp;В главе 3 было показано, как можно подключиться к портам TCP 389 и TCP 3268 через службу LDAP и глобальный каталог соответственно и получить данные с сервера.</li>
  <li>&nbsp;Как отмечалось в главе 3, служба сеансов NetBIOS Session Service, работающая через порт TCP 139, является одним из источников утечки информации и потенциального взлома сети под управлением Windows NT. Большинство действий, описанных в главе 5, выполняется исключительно через соединения по протоколу NetBIOS. Данные операционной системы Windows 2000 могут также быть получены через порт TCP 445.</li>
</ul>

 He забудьте прочитать раздел &quot; Отключение служб NetBIOS/SMB в Windows 2000&quot; ниже в этой главе.
<br>

Имеет смысл также защитить порты, находящиеся в состоянии ожидания запросов, отдельных компьютеров. Такая &quot;защита в глубину&quot; значительно затрудняет возможность сетевых атак. Классический совет в этой связи сводится к завершению работы всех ненужных служб с помощью программы services.msc и их отключению. Особое внимание следует уделить котроллерам доменов под управлением Windows 2000: когда контроллеру домена делегируются права сервера (Server) или расширенного сервера (Advanced Server) с помощью команды dcpromo.exe, на нем автоматически устанавливаются служба активного каталога, DNS и сервер DHCP, а также открываются соответствующие порты. Контроллеры доменов — это важнейшие компоненты сети, поэтому они требуют особого обращения. Большинство приложений, файловые службы и службы печати лучше устанавливать на других компьютерах. Стремление к минимуму — первый принцип безопасности.
<br>

Чтобы ограничить доступ к портам отдельных компьютеров, можно использовать проверенные временем фильтры для протокола TCP/IP. Доступ к этим параметрам можно получить через вкладку Options диалогового окна, открываемого с помощью команды Network and Dial-up
Connections&gt;Properties&gt;lnternet Protocol (TCP/IP) Properties&gt;Advanced. Однако здесь сохранились старые недостатки. Фильтры протокола TCP/IP применяются сразу ко всем адаптерам. Их установка приведет к невозможности загрузки данных, инициированной даже легитимными соединениями, и сделает невозможным обычный просмотр Web-страниц в броузере системы. Кроме того, для корректного вступления в силу внесенных изменений требуется перегрузить систему.
<br>
<p class="Prim">
Проведенное авторами тестирование Windows 2000 показало, что установка фильтров TCP/IP не блокирует эхо-пакетов ICMP (протокол 1), даже если отключить все протоколы IP, кроме 6 (TCP) и 17 (UDP).
</p>
<P align="center">
<span class="Text_b">
Фильтры IPSec</span></P>
<br>
<p class="Text_n">
Для установки фильтров на порты отдельных компьютеров лучше использовать фильтры протокола IPSec. Эти фильтры явились побочным результатом новой реализации протокола IPSec для Windows 2000 и были с успехом использованы командами разработчиков сетей Openhack и windows2000test.com. Фильтры IPSec обрабатывают пакеты в стеке сети и просто-напросто выбрасывают те из них, которые не удовлетворяют характеристикам фильтра. В отличие от фильтров TCP/IP фильтры IPSec можно применять к отдельным интерфейсам. Кроме того, они блокируют запросы ICMP (однако они не настолько &quot;тонки&quot;, чтобы блокировать отдельные подтипы запросов ICMP, скажем, эхо, отклики на эхо-запросы, временные метки и т.д.). Для вступления в силу фильтров IPSec перезагрузка не требуется (хотя изменение параметров фильтров может привести к разрыву существующих соединений IPSec). Такие фильтры обеспечивают решение проблемы для сервера и неприменимы в качестве средства обеспечения функциональности брандмауэра для рабочих станций, поскольку подобно фильтрам TCP/IP они будут блокировать загрузку информации, инициированную даже допустимыми соединениями (если не будут открыты все порты с более высокими номерами).
<br>

Фильтры IPSec можно создать с помощью аплета Administrative Tools^Local Security Policy (secpol .msc). Щелкните правой кнопкой на элементе IPSec Policies On Local Machine в левой панели окна, а затем выберите из контекстного меню команду Manage IP Filter Lists And Filter Actions.
<br>

Для управления фильтрами IPSec автор книги предпочитает использовать утилиту командной строки ipsecpol.exe. Ее можно применять при создании сценариев, а, кроме того, пользоваться ею гораздо проще, чем утилитой
управления политикой IPSec с графическим интерфейсом. Утилиту ipsecpol.exe можно найти по адресу
<span class="Text_b"> http:/www.microsoft.com/technet/security/tools.asp</span> среди средств конфигурирования безопасности Windows 2000 Internet Server. Следующие команды утилиты ipsecpol. ехе позволяют оставить открытым на данном компьютере только порт 80.
<br>
<p class="Code">
ipsecpol \\имя_компыотера -w REG -p  &quot;Web&quot; -о<br>
ipsecpol \\имя_компьютера -х -w REG -p  &quot;Web&quot;-r<br>
&quot;BlockAll&quot;  -n BLOCK -f  0+* ipsecpol  <br>
\\имл_комльютера   -x  -w REG  -p  &quot;Web&quot; -r  <br>
&quot;OkHTTP&quot;   -n  PASS  -f 0:80+*::TCP<br>
</p>

Две последние команды создают политику IPSec под названием Web, включающую два правила фильтрации. Первое из них, BlockAll, блокирует все протоколы поступающих и исходящих сообщений для данного компьютера и всех других компьютеров, а второе, OkHTTP, разрешает трафик через порт 80 данного и всех остальных компьютеров. Если нужно разрешить использование утилиты ping, или других программ, работающих на базе протокола ICMP (чего мы настоятельно не рекомендуем делать без особой необходимости), то в политику Web можно включить такое правило.
<br>

<span class="Text_b">
ipsecpol  \\имя_компыотера -х -w REG -p &quot;Web&quot; -r &quot;OkICMP&quot; -n PASS -f
0+*::ICMP</span>
<br>

&nbsp;В этом примере политика устанавливается для всех адресов, однако ее можно легко модифицировать на случай одного IP-адреса с помощью ключа -f (табл. 6.2) и направить действие этого правила на один интерфейс. Если система сконфигурирована с помощью этого примера, то при сканировании портов будет виден только порт 80. После отключения политики все порты снова станут доступными.
<br>

Описание всех аргументов, использованных в примере, приводится в табл. 6.2 (для получения полной информации о возможностях утилиты ipsecpol запустите команду ipsecpol -?).
<br>
<P class="text_n"><span class="label">
Таблица 6.2. Параметры утилиты ipsecpol, используемые для фильтрации трафика через компьютеры под управлением Windows 2000
</span></p>
<TABLE  BORDER="1" CELLSPACING="2" CELLPADDING="2" WIDTH="100%" bordercolordark="#000000"
bordercolorlight="#000000" class="border" >
<TR >
<TD   >


<span class="Text_b">
Параметр</span>
<br>

</TD>
<TD   >


<span class="Text_b">
Описание</span>
<br>

</TD>
</TR>
<TR >
<TD    >


-w  REG
<br>

</TD>
<TD    >


Переводит утилиту ipsecpol в статический режим (static mode), при котором выполняется запись политики в указанное местоположение (в отличие от используемого по умолчанию динамического режима, который действует только во время функционирования службы Policy Agent). Параметр REG определяет, что политика будет записана в системный реестр и подходит для отдельно стоящих Web-серверов (другой параметр, DS, позволяет записывать политику в каталог)
<br>

</TD>
</TR>
<TR >
<TD    >


-P
<br>

</TD>
<TD    >


Задает произвольное имя (например, web) для данной политики. Если уже существует политика с таким именем, то данное правило добавляется к ней. Например, в третьей строке к политике Web добавляется правило ОШТТР
<br>

</TD>
</TR>
<TR >
<TD    >


-r
<br>

</TD>
<TD    >


Задает произвольное имя для правила. Если политика уже включает правило с таким именем, то новое правило его заменит
<br>

</TD>
</TR>
<TR >
<TD    >


-n
<br>

</TD>
<TD    >


В статическом режиме может принимать одно из трех значений: BLOCK, PASS и IN PASS. Конкретные значения параметра описываются ниже
<br>

</TD>
</TR>
<TR >
<TD    >


BLOCK
<br>

</TD>
<TD    >


Исключает остальные значения параметра -п и создает фильтры блокировки. Эта команда аналогична выбору переключателя Block в программе управления политикой IPSec с графическим интерфейсом
<br>

</TD>
</TR>
<TR >
<TD    >


PASS
<br>

</TD>
<TD    >


Исключает остальные значения параметра -п и создает фильтры, обеспечивающие передачу данных через порты. Эта команда аналогична выбору переключателя Permit в программе управления политикой IPSec с графическим интерфейсом
<br>

</TD>
</TR>
<TD   >


-f
<br>

</TD>
<TD   >


Задает список, состоящий из одного или нескольких IP-фильтров. Правила фильтрации задаются в следующем формате, получившем название спецификации фильтра (filterspec):
<br>

<span class="Text_b">
А . B . C . D/ маска: порт=А .B.C. D/<br>маска : порт:Ipprotocol</span>
<br>

где в левой части равенства всегда задается адрес источника, а в правой — адрес получателя. Если знак = заменить на символ +, то будут созданы два зеркальных (mirrored) фильтра, по одному в каждом направлении. Маску и номер порта задавать необязательно. Если они не указаны, то в качестве маски подсети используется 255. 255. 255. 255,
а в качестве номера порта — любой порт. Комбинацию А . в .
C . D/ маска можно заменить следующими символами:
<br>

0 задает адрес локальной системы&nbsp;
<br>

 * обозначает произвольный адрес&nbsp;
<br>

 имя ONS (заметим, что множественное разрешение игнорируется).
<br>

Тип IP-протокола (например, ICMP) задавать необязательно. Если он не указан, то подразумевается любой IP-протокол. Чтобы задать конкретный IP-протокол, перед его названием необходимо точно указать номер порта или символ : :
<br>

</TD>
<TR >
<TD    >

-x
<br>

</TD>
<TD    >


Необязательный параметр, активизирующий политику в случае ее записи в системный реестр локальной машины (он использовался в предыдущем примере при определении первого правила. По каким-то причинам этот параметр работает только при создании первого фильтра политики)
<br>

</TD>
</TR>
<TR >
<TD    >


-у
<br>

</TD>
<TD    >


Необязательный параметр, отключающий политику в случае ее записи в системный реестр локальной машины
<br>

</TD>
</TR>
<TR >
<TD    >



-o

<br>

</TD>
<TD    >


Необязательный параметр, удаляющий политику, имя которой задано параметром -р. (Заметим, что при этом удаляются все аспекты указанной политики. Его не следует использовать, если другие политики ссылаются на объекты данной политики)
<br>

</TD>
</TR>
</TABLE>
<P class="text_n">
Следует отметить, что фильтры IPSec не блокируют порт 500 (UDP) или, на контроллерах домена Win 2000, порт 88 (TCP/UDP), используемые для аутентификации IPSec (порт 88 применяется протоколом Kerberos, a 500 — для обмена ключами IKE (Internet Key Exchange)). Сервисный пакет Service Pack 1 включает новый параметр реестра, позволяющий закрыть порты Kerberos путем отмены привилегий для драйвера IPSec:
<br>
<p class="Code">
HKLM\SYSTEM\CurrentControlSet\<br>
Services\IPSEC\NoDefaultExempt<br>
Type:  DWORD<br>
Max:     1<br>
Min:     0<br>
Default: 0<br>
</p>

Трафик IKE всегда был привилегированным, и параметры системного реестра на него не влияли. Если же этот параметр реестра принимает значение 1, то все &quot;льготы&quot; для протоколов Kerberos и RSVP отменяются по умолчанию.
<br>
<p class="Prim">
Автор высказывает благодарность Майклу Ховарду (Michael Howard) из группы обеспечения безопасности Windows 2000 за помощь в изучении команды ipsecpol и нового параметра системного реестра.
</p>

Поскольку утилита ipsecpol использует синтаксис командной строки, с ней нужно обращаться очень осторожно. В рассмотренном выше примере предполагается, что список фильтров обрабатывается сверху вниз. Простое изменение порядка следования записей в списке может привести к неправильной работе фильтров. Кроме того, утилита не позволяет задать диапазон портов для источника или назначения. Так что несмотря на значительные улучшения, обеспечиваемые фильтрами IPSec по сравнению с фильтрами TCP/IP, с ними нужно обращаться очень аккуратно. Иначе желание блокировать порты так и останется лишь желанием. Отметим еще несколько особенностей, выявленных процессе интенсивного тестирования утилиты
ipsecpol.
<br>
<ul>
  <li>&nbsp;Для отмены политики иногда приходится отключать ее с помощью ключа -у до или после ее удаления с использованием параметра -о. Автору приходилось сталкиваться с ситуацией, когда даже удаленная политика продолжает действовать до момента ее отключения.</li>
  <li>&nbsp;При изменении политики необходимо пользоваться либо только утилитой командной строки ipsecpol, либо исключительно программой с графическим интерфейсом. Если политика была создана с помощью программы ipsecpol, а затем отредактирована в другой программе, то при ее работе возможны сбои и бреши в защите.</li>
  <li>&nbsp;Не забывайте удалять ненужные фильтры, чтобы избежать конфликтов. Эту задачу лучше выполнять с помощью программы с графическим интерфейсом, поскольку в ней отображается список всех существующих фильтров.</li>
</ul>

<br>


</p></td>
  </tr>
</table>
<br>
<table BORDER=0  COLS=3 WIDTH="11%" >
  <tr> 
   <td><a href="Index2.html"><img SRC="Back.gif"  BORDER=0 ></a></td>
    <td WIDTH="10%"><a href="../menu.html"><img SRC="Menu.gif" BORDER=0 ></a></td>
    <td ALIGN=RIGHT><a href="Index4.html"><img SRC="For.gif" BORDER=0 ></a></td>
   
  </tr>
</table>
</body>
</html>
